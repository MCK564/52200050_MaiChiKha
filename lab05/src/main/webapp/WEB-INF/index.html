<!DOCTYPE html>
<html lang="en">
<head>
    <title>Danh sách sản phẩm</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body style="background-color: #f8f8f8">

<div class="container-fluid p-5">
    <div class="row mb-5">
        <div class="col-md-6">
            <h3>Product Management</h3>
        </div>
        <div class="col-md-6 text-right">
            Xin chào <span class="text-danger username">...</span> |
            <form action = "/products" method="post">
                <input type ="hidden" name="action" class="btn btn-info" value="logout">
                <button type="submit" class="btn btn-info">
                    Log out ->
                </button>
            </form>

        </div>
    </div>
    <div class="row rounded border p-3">
        <div class="col-md-4">
            <h4 class="text-success">Thêm sản phẩm mới</h4>
            <form class="mt-3" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="product-id">ID</label>
                    <input class="form-control"  type="number" placeholder="" id="product-id" name="id" disabled>
                </div>
                <div class="form-group">
                    <label for="product-name">Tên sản phẩm</label>
                    <input class="form-control"  type="text" placeholder="Nhập tên sản phẩm" id="product-name" name="name">
                </div>
                <div class="form-group">
                    <label for="price">Giá sản phẩm</label>
                    <input class="form-control"  type="number" placeholder="Nhập giá bán" id="price" name="price">
                </div>
                <div class="form-group d-flex">
                    <button class="btn btn-success mr-2" type="button" onclick="addProduct()">Thêm sản phẩm</button>
                    <button class="btn btn-outline-success " type="reset" id="button-reset">Reset</button>
                </div>

                <div class="alert alert-danger d-none" id="error-message">
                    Vui lòng nhập tên sản phẩm
                </div>
            </form>
        </div>
        <div class="col-md-8">
            <h4 class="text-success">Danh sách sản phẩm</h4>
            <p>Chọn một sản phẩm cụ thể để xem chi tiết</p>
           <div id="product-list">

           </div>
        </div>
    </div>
</div>
<script>
    // Add the following code if you want the name of the file appear on select
    $(".custom-file-input").on("change", function() {
        var fileName = $(this).val().split("\\").pop();
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
    });
    function fetchListProducts() {
        fetch('/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'action=getAllProducts'
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Failed to fetch list of products');
            })
            .then(htmlTable => {

                document.getElementById('product-list').innerHTML = htmlTable;
            })
            .catch(error => console.error(error));
    }
    fetchListProducts();
    function getUsername() {
        fetch('/products', { method: 'GET' })
            .then(response => {
                if (response.ok){
                    return response.json();
                }
                throw new Error('Failed to fetch username');
            })
            .then(data => {
                // Tìm phần tử HTML có class là "text-danger" và cập nhật nội dung thành username
                const usernameElement = document.querySelector('.username');
                if (usernameElement) {
                    usernameElement.textContent = data.username;
                }
            })
            .catch(error => console.error(error)); // Xử lý lỗi nếu có
    }
    window.onload = getUsername;
    function logout(){
        fetch('/products',{method:''})
    }

    function addProduct(){
        var name = document.getElementById('product-name');
        var price = document.getElementById('price');
        var id = document.getElementById('product-id');
        var action = "addProduct";
        var errorMessage = document.getElementById('error-message');
        if(name.value == null || price.value == null){
            errorMessage.classList.remove("d-none");
        }
        else{
            errorMessage.classList.add('d-none');
            var data ={
                id: id.value===""?0:id.value,
                name:name.value,
                price:parseFloat(price.value),
                action:action
            }
            console.log(data);
            fetch('/products', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                      return response.json();
                    } else {
                        throw new Error('Failed to add product');
                    }
                })
                .then((data)=>{
                    alert("successfull creating");
                    var button_reset= document.getElementById('button-reset');
                    button_reset.click();

                })
                .catch(error => console.error(error));
        }

    }
    function updateProduct(productId){
        fetch('/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'action=getOneProductById&id=' + productId
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Failed to fetch product by ID');
            })
            .then(productInfo => {
                var name = document.getElementById('product-name');
                var price = document.getElementById('price');
                var id = document.getElementById('product-id');

                var parsedProductInfo = JSON.parse(productInfo);
                name.value = parsedProductInfo.name;
                id.value =parsedProductInfo.id;
                price.value =parsedProductInfo.price;
                name.focus();

            })
            .catch(error => console.error(error));
    }

    function deleteProduct(id) {
        console.log(id);
        fetch('/products?id=' + id, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {

                   alert("delete success");
                }
            })
            .catch(error => console.error(error));
    }



</script>
</body>
</html>
